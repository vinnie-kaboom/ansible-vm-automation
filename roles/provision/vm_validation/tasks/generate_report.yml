---
# Generate validation results summary (console output only)
# This task compiles all validation results and displays them to the user
- name: "Compile validation results"
  ansible.builtin.set_fact:
    validation_report:
      timestamp: "{{ now(utc=true, fmt='%Y-%m-%dT%H:%M:%SZ') }}"
      vm_name: "{{ config_vm_name | default(inventory_hostname) }}"
      environment: "{{ config_vm_environment | default('UNKNOWN') }}"
      validations:
        config: "{{ validation_results.config | default('PENDING') }}"
        resources: "{{ validation_results.resources | default('PENDING') }}"
        network: "{{ validation_results.network | default('PENDING') }}"
      warnings: "{{ validation_warnings | default([]) }}"
  tags: validation

- name: "Display validation summary"
  ansible.builtin.debug:
    msg:
      - "========================================="
      - "VM Validation Report"
      - "========================================="
      - "VM Name: {{ validation_report.vm_name }}"
      - "Environment: {{ validation_report.environment }}"
      - "Timestamp: {{ validation_report.timestamp }}"
      - "========================================="
      - "Validation Results:"
      - "  Config: {{ validation_report.validations.config }}"
      - "  Resources: {{ validation_report.validations.resources }}"
      - "  Network: {{ validation_report.validations.network }}"
      - "========================================="
  tags: validation

- name: "Note pending validations"
  ansible.builtin.debug:
    msg: "⚠️  Note: {{ item.key }} validation is PENDING (not implemented or skipped)"
  loop:
    - { key: 'config', value: "{{ validation_report.validations.config }}" }
    - { key: 'resources', value: "{{ validation_report.validations.resources }}" }
    - { key: 'network', value: "{{ validation_report.validations.network }}" }
  when: item.value == 'PENDING'
  tags: validation

- name: "Display validation summary"
  ansible.builtin.debug:
    msg:
      - "========================================="
      - "Validation Summary"
      - "========================================="
      - "VM Name: {{ validation_report.vm_name }}"
      - "Environment: {{ validation_report.environment }}"
      - "Timestamp: {{ validation_report.timestamp }}"
      - ""
      - "Validation Results:"
      - "  Config: {{ validation_report.validations.config }}"
      - "  Resources: {{ validation_report.validations.resources }}"
      - "  Network: {{ validation_report.validations.network }}"
      - "========================================="
  tags: validation

- name: "Fail if any validation failed"
  ansible.builtin.fail:
    msg: |
      ❌ Validation failed. See results above.
      
      Failed validations:
      {% if validation_report.validations.config == 'FAILED' %}  - Configuration validation{% endif %}
      {% if validation_report.validations.resources == 'FAILED' %}  - Resource validation{% endif %}
      {% if validation_report.validations.network == 'FAILED' %}  - Network validation{% endif %}
  when: >
    validation_report.validations.config == 'FAILED' or
    validation_report.validations.resources == 'FAILED' or
    validation_report.validations.network == 'FAILED'
  tags: validation