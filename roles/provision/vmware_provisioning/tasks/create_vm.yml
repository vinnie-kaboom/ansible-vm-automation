---
# Creates VM from template with network and OS customization
# Supports both Linux and Windows with async execution

# Dry-run simulation for check mode
- name: "Clone VM from template (Check Mode)"
  ansible.builtin.debug:
    msg: "CHECK MODE: Would clone {{ config_vm_name }} from template {{ config_vm_template }}"
  when: ansible_check_mode

# Query vCenter for VM existence and current state
- name: "Check if VM already exists"
  community.vmware.vmware_guest_info:
    hostname: "{{ vcenter_host }}"
    name: "{{ config_vm_name }}"
    datacenter: "{{ config_vcenter_datacenter }}"
  register: existing_vm_check
  delegate_to: localhost
  connection: local
  ignore_errors: true
  when: not ansible_check_mode

# Display VM existence and power state for visibility
- name: "Display existing VM status"
  ansible.builtin.debug:
    msg:
      - "VM {{ config_vm_name }} existence check:"
      - "Exists: {{ existing_vm_check.instance is defined }}"
      - "Power State: {{ existing_vm_check.instance.hw_power_status | default('N/A') }}"
  when:
    - not ansible_check_mode
    - existing_vm_check is defined

# Clone VM from template with network, hardware, and OS customization
# Runs async to avoid blocking on long operations
- name: "Clone VM from template with inline customization"
  community.vmware.vmware_guest:
    hostname: "{{ vcenter_host }}"
    name: "{{ config_vm_name }}"
    template: "{{ config_vm_template }}"
    datacenter: "{{ config_vcenter_datacenter }}"
    cluster: "{{ config_vcenter_cluster }}"
    folder: "{{ config_vm_folder }}"
    datastore: "{{ config_vcenter_datastore }}"
    resource_pool: "{{ config_vcenter_resource_pool | default(omit) }}"
    state: present
    networks:
      - name: "{{ config_vm_network }}"
        ip: "{{ config_vm_network_start_ip }}"
        netmask: "{{ config_vm_network_netmask }}"
        gateway: "{{ config_vm_network_gateway }}"
        domain: "{{ config_vm_domain }}"
        dns_servers: "{{ config_vm_network_dns_servers }}"
        type: "{{ config_vm_network_type | default('static') }}"
        device_type: "{{ config_vm_network_device_type | default('vmxnet3') }}"
        start_connected: "{{ config_vm_network_start_connected | default(true) }}"
    customization: "{{ linux_customization if (config_vm_os is defined and ('Linux' in config_vm_os or 'RHEL' in config_vm_os)) else (windows_customization if (config_vm_os is defined and 'Windows' in config_vm_os) else omit) }}"
    hardware:
      memory_mb: "{{ config_vm_memory_mb }}"
      num_cpus: "{{ config_vm_cpu_count }}"
      scsi: paravirtual
    wait_for_customization: false
    wait_for_ip_address: false
  async: "{{ vm_async_timeout | default(3600) | int }}"
  poll: "{{ vm_poll_interval | default(0) | int }}"
  register: vm_creation
  when: not ansible_check_mode
  delegate_to: localhost
  connection: local

# Poll async job until completion or timeout
- name: "Wait for VM creation to complete"
  ansible.builtin.async_status:
    jid: "{{ vm_creation.ansible_job_id }}"
  register: job_result
  until: job_result.finished
  retries: "{{ config_vm_async_retries | int }}"
  delay: "{{ config_vm_async_delay | int }}"
  when:
    - not ansible_check_mode
    - vm_creation.ansible_job_id is defined
  delegate_to: localhost
  connection: local

# Add creation metadata to VM notes field
- name: "Update VM annotation"
  community.vmware.vmware_guest:
    hostname: "{{ vcenter_host }}"
    name: "{{ config_vm_name }}"
    datacenter: "{{ config_vcenter_datacenter }}"
    annotation: "Created by Ansible Magic on {{ ansible_date_time.date }}"
    state: present
  when: not ansible_check_mode
  delegate_to: localhost
  connection: local

# Show summary of VM creation operation
- name: "Display VM creation result"
  ansible.builtin.debug:
    msg:
      - "========================================="
      - "VM Creation Status"
      - "========================================="
      - "VM Name: {{ config_vm_name }}"
      - "Template: {{ config_vm_template }}"
      - "Status: {{ 'SUCCESS' if (job_result is defined and job_result.finished == 1) else 'FAILED' }}"
      - "Changed: {{ job_result.changed | default(false) }}"
      - "Datacenter: {{ config_vcenter_datacenter }}"
      - "Cluster: {{ config_vcenter_cluster }}"
      - "Datastore: {{ config_vcenter_datastore }}"
      - "========================================="
  when:
    - not ansible_check_mode
    - job_result is defined

# Retrieve detailed error information from async job result file
- name: "Read async job result file for error details"
  ansible.builtin.slurp:
    src: "{{ job_result.results_file }}"
  register: async_job_details
  delegate_to: localhost
  connection: local
  ignore_errors: true
  when:
    - not ansible_check_mode
    - job_result is defined
    - job_result.finished != 1
    - job_result.results_file is defined

# Display detailed error information if job failed
- name: "Display async job error details"
  ansible.builtin.debug:
    msg:
      - "========================================="
      - "Async Job Error Details"
      - "========================================="
      - "{{ async_job_details.content | b64decode | from_json }}"
      - "========================================="
  when:
    - not ansible_check_mode
    - async_job_details is defined
    - async_job_details.content is defined

# Fail playbook if VM creation timed out or failed
- name: "Fail if VM creation did not complete"
  ansible.builtin.fail:
    msg: |
      VM creation failed or timed out after {{ config_vm_async_retries * config_vm_async_delay }} seconds.
      
      Possible causes:
      1. vCenter is overloaded or slow
      2. Datastore has insufficient space or poor performance
      3. Template is corrupted or missing
      4. Network connectivity issues to vCenter
      5. VM already exists and reconfiguration is hanging
      6. DRS is interfering with VM creation
      7. Guest customization is hanging (template not properly prepared)
      
      Check vCenter tasks for VM {{ config_vm_name }} to see actual status.
      Check the async job details above for specific error messages.
  when:
    - not ansible_check_mode
    - job_result is defined
    - job_result.finished != 1

# Dry-run simulation for check mode
- name: "Power on VM (Check Mode)"
  ansible.builtin.debug:
    msg: "CHECK MODE: Would power on {{ config_vm_name }}"
  when: ansible_check_mode

# Power on VM (idempotent - no-op if already powered on)
- name: "Power on VM"
  community.vmware.vmware_guest_powerstate:
    hostname: "{{ vcenter_host }}"
    name: "{{ config_vm_name }}"
    datacenter: "{{ config_vcenter_datacenter }}"
    state: powered-on
  when: not ansible_check_mode
  delegate_to: localhost
  connection: local
