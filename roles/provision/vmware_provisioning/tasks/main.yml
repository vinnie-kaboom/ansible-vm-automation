---
# VMware Provisioning Role - Main Task Orchestrator
# Coordinates VM vm-operations workflow with separation of concerns

- name: "Pre-flight validation"
  include_tasks: validate.yml
  tags:
    - validation
    - vm-operations

- name: "Provision VM in vCenter"
  include_tasks: create_vm.yml
  tags:
    - vm-operations
    - vm_creation
  when: not (dry_run | default(false) | bool)

- name: "Wait for VMware Tools and customization"
  include_tasks: wait_for_customization.yml
  tags:
    - vm-operations
    - customization
  when: not (dry_run | default(false) | bool)

- name: "Validate network connectivity"
  include_tasks: validate_network.yml
  tags:
    - vm-operations
    - validation
    - network
  when: not (dry_run | default(false) | bool)

- name: "Validate SSH connectivity"
  include_tasks: validate_ssh.yml
  tags:
    - vm-operations
    - validation
    - ssh
  when:
    - not (dry_run | default(false) | bool)
    - config_validate_ssh | default(true)

- name: "Configure sshd hardening"
  include_tasks: configure_sshd.yml
  tags:
    - vm-operations
    - ssh
    - hardening
  when:
    - not (dry_run | default(false) | bool)
    - config_vm_os is defined
    - "'Linux' in config_vm_os or 'RHEL' in config_vm_os"

- name: "Report vm-operations issues"
  ansible.builtin.debug:
    msg:
      - "========================================="
      - "⚠️  VM PROVISIONING ISSUES DETECTED"
      - "========================================="
      - "VM: {{ config_vm_name }}"
      - "Issues found:"
      - "{{ vm_provisioning_issues | default([]) | join('\n') }}"
      - "========================================="
      - "Note: VM was created but has connectivity issues"
      - "Manual intervention may be required"
      - "========================================="
  when:
    - not ansible_check_mode
    - vm_provisioning_issues is defined
    - vm_provisioning_issues | length > 0

- name: "Fail if critical vm-operations issues detected"
  ansible.builtin.fail:
    msg: |
      ❌ VM provisioning completed with CRITICAL issues
      
      VM: {{ config_vm_name }}
      IP: {{ config_vm_network_start_ip }}
      
      Issues:
      {{ vm_provisioning_issues | default([]) | join('\n  - ') }}
      
      The VM was created in vCenter but has connectivity problems.
      Check the VM console and network configuration.
  when:
    - not ansible_check_mode
    - config_fail_on_connectivity_issues | default(false) | bool
    - vm_provisioning_issues is defined
    - vm_provisioning_issues | length > 0
  tags:
    - vm-operations
    - validation