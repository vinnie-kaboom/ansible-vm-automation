---
# Validate VM configuration: ensure the referenced template exists and is valid.
# This file has been completely rewritten to remove any ISO-related code.

- name: "Run configuration validation"
  block:
    - name: "Collect required parameters for template validation"
      ansible.builtin.set_fact:
        _template_name: "{{ config_vm_template | default(vm_template | default(template_name | default(config_template | default(vm_template_name | default(None))))) }}"
        _template_folder: "{{ vm_folder | default(template_folder | default(None)) }}"
        _use_content_library: "{{ (use_content_library | default(false)) or (content_library_name is defined) }}"

    - name: "Assert template name provided"
      ansible.builtin.assert:
        that:
          - _template_name is not none
          - _template_name | length > 0
        fail_msg: "Template name is required for template-based provisioning. Set one of: vm_template, template_name, config_template, vm_template_name."
        success_msg: "Template '{{ _template_name }}' will be validated during provisioning."

    - name: "Note: Template existence validation deferred to provisioning"
      ansible.builtin.debug:
        msg: "Template '{{ _template_name }}' existence will be validated during actual provisioning to avoid vSphere API hangs."

    - name: "Set config validation result - PASSED"
      set_fact:
        validation_results: "{{ validation_results | combine({'config': 'PASSED'}) }}"

  rescue:
    - name: "Set config validation result - FAILED"
      set_fact:
        validation_results: "{{ validation_results | combine({'config': 'FAILED'}) }}"

  tags: [provision, validation]