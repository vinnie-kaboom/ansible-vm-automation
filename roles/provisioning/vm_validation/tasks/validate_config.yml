---
- name: "Run configuration validation with error handling"
  block:
    - name: "Collect required parameters for template validation"
      ansible.builtin.set_fact:
        _template_name: "{{ config_vm_template | default('') }}"
        _template_folder: "{{ vm_folder | default(template_folder | default('')) }}"
        _use_content_library: "{{ (use_content_library | default(false)) or (content_library_name is defined) }}"
      tags: [provision, validation]

    - name: "Display provisioning method"
      ansible.builtin.debug:
        msg: "Using template-based provisioning method"
      tags: [provision, validation]

    - name: "Assert template name provided"
      ansible.builtin.assert:
        that:
          - config_vm_template is defined
          - _template_name | length > 0
        fail_msg: >-
          config_vm_template is not set for host '{{ inventory_hostname }}'.
          Define it in the appropriate zone or host group_vars file
          (e.g., inventory/group_vars/<zone>.yml).
        success_msg: "Template '{{ _template_name }}' will be validated."
      tags: [provision, validation]

    - name: "Debug vCenter connection parameters"
      ansible.builtin.debug:
        msg:
          - "vCenter Host: {{ vcenter_host }}"
          - "Datacenter: {{ vcenter_datacenter }}"
          - "Template: {{ _template_name }}"
      when: not _use_content_library
      tags: [provision, validation]

    - name: "Skip template vSphere query (template validated during provisioning)"
      ansible.builtin.set_fact:
        _template_info: "{{ {'instance': {'hw_is_template': true}, 'skipped': true} }}"
      when: not _use_content_library
      tags: [provision, validation]

    - name: "Assert template object was returned"
      ansible.builtin.assert:
        that:
          - _template_info is defined
          - _template_info.instance is defined
        fail_msg: "Template '{{ _template_name }}' not found."
        success_msg: "Template '{{ _template_name }}' exists in vSphere."
      when: not _use_content_library
      tags: [provision, validation]

    - name: "Assert object is a template (not a VM)"
      ansible.builtin.assert:
        that:
          - _template_info.instance.hw_is_template | default(false)
        fail_msg: "'{{ _template_name }}' exists but is not marked as a template."
        success_msg: "Template '{{ _template_name }}' is a valid vSphere template."
      when: not _use_content_library
      tags: [provision, validation]

    - name: "Display resolved validation parameters"
      ansible.builtin.debug:
        msg: "Validated template '{{ _template_name }}' in datacenter '{{ vcenter_datacenter }}'"
      tags: [provision, validation]

    - name: "Set config validation result - PASSED"
      ansible.builtin.set_fact:
        validation_results: "{{ validation_results | combine({'config': 'PASSED'}) }}"
      tags: [provision, validation]

  rescue:
    - name: "Set config validation result - FAILED"
      ansible.builtin.set_fact:
        validation_results: "{{ validation_results | combine({'config': 'FAILED'}) }}"
      tags: [provision, validation]

    - name: "Fail with config validation error"
      ansible.builtin.fail:
        msg: "Configuration validation failed"
      tags: [provision, validation]