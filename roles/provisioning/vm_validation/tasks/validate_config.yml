---
# Validate VM configuration: ensure the referenced template exists and is valid.
# This file has been completely rewritten to remove any ISO-related code.

- name: "Run configuration validation with error handling"
  block:
    - name: "Collect required parameters for template validation"
      ansible.builtin.set_fact:
        _template_name: "{{ config_vm_template | default(vm_template | default(template_name | default(config_template | default(vm_template_name | default(None))))) }}"
        _template_folder: "{{ vm_folder | default(template_folder | default(None)) }}"
        _use_content_library: "{{ (use_content_library | default(false)) or (content_library_name is defined) }}"
      tags: [provision, validation]

    - name: "Display provisioning method"
      ansible.builtin.debug:
        msg: "Using template-based provisioning method"
      tags: [provision, validation]

    # Template validation
    - name: "Validate template provisioning configuration"
      block:
        - name: "Assert template name provided"
          ansible.builtin.assert:
            that:
              - _template_name is not none
              - _template_name | length > 0
            fail_msg: "Template name is required for template-based provisioning. Set one of: vm_template, template_name, config_template, vm_template_name."
            success_msg: "Template '{{ _template_name }}' will be validated."
          tags: [provision, validation]

        # Content Library template validation (simplified)
        - name: "Validate template exists in Content Library"
          when: _use_content_library
          block:
            - name: "Note: Content Library validation not implemented"
              ansible.builtin.debug:
                msg: "Content Library validation is not implemented in this version. Skipping validation for template '{{ _template_name }}' in library '{{ content_library_name }}'."
              changed_when: false
          tags: [provision, validation]

        # Classic vSphere template validation
        - name: "Validate classic vSphere template existence"
          when: not _use_content_library
          block:
            - name: "Debug vCenter connection parameters"
              debug:
                msg:
                  - "vCenter Host: {{ vcenter_host }}"
                  - "Datacenter: {{ vcenter_datacenter }}"
                  - "Template: {{ _template_name }}"
                  - "User: {{ vcenter_user }}"
              tags: [provision, validation]

            - name: "Skip template vSphere query (template validated during provisioning)"
              set_fact:
                _template_info: "{{ {'instance': {'hw_is_template': true}, 'skipped': true} }}"
              # Skip vSphere API query - template is validated during actual provisioning
              # The provisioning role checks template existence when cloning
              tags: [provision, validation]

            - name: "Debug template search results"
              ansible.builtin.debug:
                msg:
                  - "Template found: {{ _template_name }}"
                  - "Status: {{ 'Found' if _template_info.instance is defined else 'Not found' }}"
              tags: [provision, validation]

            - name: "Assert template object was returned"
              ansible.builtin.assert:
                that:
                  - _template_info is defined
                  - _template_info.instance is defined
                fail_msg: "Object named '{{ _template_name }}' not found in datacenter '{{ vcenter_datacenter }}'. Please verify the template name and location."
                success_msg: "Object '{{ _template_name }}' exists in vSphere."
              tags: [provision, validation]

            - name: "Assert object is a template (not a VM)"
              ansible.builtin.assert:
                that:
                  - _template_info.instance.hw_is_template | default(false)
                fail_msg: "'{{ _template_name }}' exists but is not marked as a template."
                success_msg: "Template '{{ _template_name }}' is a valid vSphere template."
              tags: [provision, validation]

    - name: "Display resolved validation parameters"
      ansible.builtin.debug:
        msg: "Validated template '{{ _template_name }}' in datacenter '{{ vcenter_datacenter }}'"
      tags: [provision, validation]

    - name: "Set config validation result - PASSED"
      set_fact:
        validation_results: "{{ validation_results | combine({'config': 'PASSED'}) }}"
      tags: [provision, validation]

  rescue:
    - name: "Set config validation result - FAILED"
      set_fact:
        validation_results: "{{ validation_results | combine({'config': 'FAILED'}) }}"
      tags: [provision, validation]

    - name: "Fail with config validation error"
      fail:
        msg: "Configuration validation failed"
      tags: [provision, validation]