---

- name: "Wait for VMware Tools to become available"
  community.vmware.vmware_guest_tools_wait:
    hostname: "{{ vcenter_host }}"
    username: "{{ vcenter_user }}"
    password: "{{ vcenter_user_password }}"
    validate_certs: "{{ vcenter_validate_certs }}"
    name: "{{ config_vm_name }}"
    datacenter: "{{ config_vcenter_datacenter }}"
  when: not ansible_check_mode
  delegate_to: localhost
  connection: local
  retries: "{{ config_vm_max_retries | default(3) | int }}"
  delay: "{{ config_vm_retry_delay | default(10) | int }}"
  register: vmtools_wait

- name: "Wait for guest OS customization to complete"
  community.vmware.vmware_guest_info:
    hostname: "{{ vcenter_host }}"
    username: "{{ vcenter_user }}"
    password: "{{ vcenter_user_password }}"
    validate_certs: "{{ vcenter_validate_certs }}"
    name: "{{ config_vm_name }}"
    datacenter: "{{ config_vcenter_datacenter }}"
  register: vm_info
  until: >
    vm_info.instance is defined and
    vm_info.instance.hw_power_status is defined and
    vm_info.instance.hw_power_status == "poweredOn" and
    vm_info.instance.guest_tools_status is defined and
    vm_info.instance.guest_tools_status == "guestToolsRunning" and
    (vm_info.instance.customization_info is not defined or
     vm_info.instance.customization_info.status is not defined or
     vm_info.instance.customization_info.status != "TOOLSDEPLOYPKG_RUNNING")
  retries: "{{ config_vm_wait_for_guest_state_retries | int }}"
  delay: "{{ config_vm_wait_for_guest_state_delay | int }}"
  when: not ansible_check_mode
  delegate_to: localhost
  connection: local
  failed_when: false

- name: "Check if customization failed"
  ansible.builtin.set_fact:
    customization_failed: true
  when:
    - not ansible_check_mode
    - vm_info.instance is defined
    - vm_info.instance.customization_info is defined
    - vm_info.instance.customization_info.status is defined
    - vm_info.instance.customization_info.status == "TOOLSDEPLOYPKG_IDLE"

- name: "Retrieve customization log file from VM"
  community.vmware.vmware_guest_file_operation:
    hostname: "{{ vcenter_host }}"
    username: "{{ vcenter_user }}"
    password: "{{ vcenter_user_password }}"
    validate_certs: "{{ vcenter_validate_certs }}"
    datacenter: "{{ config_vcenter_datacenter }}"
    vm_id: "{{ config_vm_name }}"
    vm_username: "{{ config_vm_root_user }}"
    vm_password: "{{ config_vm_root_password }}"
    fetch:
      src: "/var/log/vmware-imc/toolsDeployPkg.log"
      dest: "/tmp/{{ config_vm_name }}_toolsDeployPkg.log"
  delegate_to: localhost
  register: log_fetch
  ignore_errors: true
  when:
    - not ansible_check_mode
    - customization_failed | default(false)

- name: "Display customization log contents"
  ansible.builtin.command:
    cmd: "cat /tmp/{{ config_vm_name }}_toolsDeployPkg.log"
  register: log_contents
  delegate_to: localhost
  ignore_errors: true
  when:
    - not ansible_check_mode
    - customization_failed | default(false)
    - log_fetch is succeeded

- name: "Show customization error details"
  ansible.builtin.debug:
    msg:
      - "========================================="
      - "CUSTOMIZATION FAILED FOR {{ config_vm_name }}"
      - "========================================="
      - "Customization Status: {{ vm_info.instance.customization_info.status | default('Unknown') }}"
      - "Error Message: {{ vm_info.instance.customization_info.errorMessage | default('No error message') }}"
      - ""
      - "Log file contents from /var/log/vmware-imc/toolsDeployPkg.log:"
      - "{{ log_contents.stdout_lines | default(['Could not retrieve log file']) }}"
      - "========================================="
  when:
    - not ansible_check_mode
    - customization_failed | default(false)

- name: "Get detailed VM network information"
  community.vmware.vmware_guest_info:
    hostname: "{{ vcenter_host }}"
    username: "{{ vcenter_user }}"
    password: "{{ vcenter_user_password }}"
    validate_certs: "{{ vcenter_validate_certs }}"
    name: "{{ config_vm_name }}"
    datacenter: "{{ config_vcenter_datacenter }}"
    schema: vsphere
  register: vm_detailed_info
  when: not ansible_check_mode
  delegate_to: localhost
  connection: local

- name: "Display VM network information from VMware Tools"
  ansible.builtin.debug:
    msg:
      - "VM Name: {{ config_vm_name }}"
      - "Expected IP: {{ config_vm_network_start_ip }}"
      - "VM IP from Tools: {{ vm_info.instance.ipv4 | default('Not yet assigned') }}"
      - "All IPs: {{ vm_detailed_info.instance.guest.ipAddress | default('None') }}"
      - "Guest Tools Status: {{ vm_info.instance.guest_tools_status | default('Unknown') }}"
      - "Power Status: {{ vm_info.instance.hw_power_status | default('Unknown') }}"
      - "Guest OS: {{ vm_detailed_info.instance.guest.guestId | default('Unknown') }}"
  when: not ansible_check_mode

- name: "Check if VM has correct IP address"
  ansible.builtin.set_fact:
    vm_has_correct_ip: "{{ (vm_info.instance.ipv4 is not none) and (vm_info.instance.ipv4 == config_vm_network_start_ip) }}"
    vm_has_any_ip: "{{ (vm_info.instance.ipv4 is not none) and (vm_info.instance.ipv4 | string | length > 0) }}"
  when: not ansible_check_mode

- name: "Display IP check result"
  ansible.builtin.debug:
    msg:
      - "========================================="
      - "VM Network Configuration Status"
      - "========================================="
      - "Expected IP: {{ config_vm_network_start_ip }}"
      - "Actual IP: {{ vm_info.instance.ipv4 | default('No IP assigned') }}"
      - "Network: {{ config_vm_network }}"
      - "Gateway: {{ config_vm_network_gateway }}"
      - "Netmask: {{ config_vm_network_netmask }}"
      - "DNS: {{ config_vm_network_dns_servers }}"
      - "Status: {{ 'CORRECT' if vm_has_correct_ip | default(false) else ('WRONG IP' if vm_has_any_ip | default(false) else 'NO IP - Network customization failed') }}"
      - "Action: {{ 'Continue' if vm_has_correct_ip | default(false) else 'Will configure network via VMware Tools' }}"
      - "========================================="
  when: not ansible_check_mode
