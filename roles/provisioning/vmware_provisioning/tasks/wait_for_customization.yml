---
# Wait for VMware Tools and Guest Customization
# Waits for VM to be fully ready with network configuration

- name: "Wait for VMware Tools to become available"
  community.vmware.vmware_guest_tools_wait:
    hostname: "{{ vcenter_host }}"
    username: "{{ vcenter_user }}"
    password: "{{ vcenter_user_password }}"
    validate_certs: "{{ vcenter_validate_certs }}"
    name: "{{ config_vm_name }}"
    datacenter: "{{ config_vcenter_datacenter }}"
  when: not ansible_check_mode
  delegate_to: localhost
  connection: local
  retries: 3
  delay: 10
  register: vmtools_wait

- name: "Wait for guest OS customization to complete"
  community.vmware.vmware_guest_info:
    hostname: "{{ vcenter_host }}"
    username: "{{ vcenter_user }}"
    password: "{{ vcenter_user_password }}"
    validate_certs: "{{ vcenter_validate_certs }}"
    name: "{{ config_vm_name }}"
    datacenter: "{{ config_vcenter_datacenter }}"
  register: vm_info
  until: >
    vm_info.instance is defined and
    vm_info.instance.hw_power_status is defined and
    vm_info.instance.hw_power_status == "poweredOn" and
    vm_info.instance.guest_tools_status is defined and
    vm_info.instance.guest_tools_status == "guestToolsRunning"
  retries: "{{ config_vm_wait_for_guest_state_retries }}"
  delay: "{{ config_vm_wait_for_guest_state_delay }}"
  when: not ansible_check_mode
  delegate_to: localhost
  connection: local

- name: "Get detailed VM network information"
  community.vmware.vmware_guest_info:
    hostname: "{{ vcenter_host }}"
    username: "{{ vcenter_user }}"
    password: "{{ vcenter_user_password }}"
    validate_certs: "{{ vcenter_validate_certs }}"
    name: "{{ config_vm_name }}"
    datacenter: "{{ config_vcenter_datacenter }}"
    schema: vsphere
  register: vm_detailed_info
  when: not ansible_check_mode
  delegate_to: localhost
  connection: local

- name: "Display VM network information from VMware Tools"
  ansible.builtin.debug:
    msg:
      - "VM Name: {{ config_vm_name }}"
      - "Expected IP: {{ config_vm_network_start_ip }}"
      - "VM IP from Tools: {{ vm_info.instance.ipv4 | default('Not yet assigned') }}"
      - "All IPs: {{ vm_detailed_info.instance.guest.ipAddress | default('None') }}"
      - "Guest Tools Status: {{ vm_info.instance.guest_tools_status | default('Unknown') }}"
      - "Power Status: {{ vm_info.instance.hw_power_status | default('Unknown') }}"
      - "Guest OS: {{ vm_detailed_info.instance.guest.guestId | default('Unknown') }}"
  when: not ansible_check_mode

- name: "Check if VM has correct IP address"
  ansible.builtin.set_fact:
    vm_has_correct_ip: "{{ (vm_info.instance.ipv4 is not none) and (vm_info.instance.ipv4 == config_vm_network_start_ip) }}"
    vm_has_any_ip: "{{ (vm_info.instance.ipv4 is not none) and (vm_info.instance.ipv4 | string | length > 0) }}"
  when: not ansible_check_mode

- name: "Display IP check result"
  ansible.builtin.debug:
    msg:
      - "========================================="
      - "VM Network Configuration Status"
      - "========================================="
      - "Expected IP: {{ config_vm_network_start_ip }}"
      - "Actual IP: {{ vm_info.instance.ipv4 | default('No IP assigned') }}"
      - "Network: {{ config_vm_network }}"
      - "Gateway: {{ config_vm_network_gateway }}"
      - "Netmask: {{ config_vm_network_netmask }}"
      - "DNS: {{ config_vm_network_dns_servers }}"
      - "Status: {{ 'CORRECT' if vm_has_correct_ip | default(false) else ('WRONG IP' if vm_has_any_ip | default(false) else 'NO IP - Network customization failed') }}"
      - "Action: {{ 'Continue' if vm_has_correct_ip | default(false) else 'Will configure network via VMware Tools' }}"
      - "========================================="
  when: not ansible_check_mode
