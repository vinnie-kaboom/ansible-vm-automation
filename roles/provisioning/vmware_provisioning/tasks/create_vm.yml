---
# VM Creation Tasks
# Creates VM from template and powers it on

- name: "Clone VM from template (Check Mode)"
  ansible.builtin.debug:
    msg: "CHECK MODE: Would clone {{ config_vm_name }} from template {{ config_vm_template }}"
  when: ansible_check_mode

- name: "Clone VM from template (idempotent - creates if missing, no-op if exists)"
  community.vmware.vmware_guest:
    hostname: "{{ vcenter_host }}"
    username: "{{ vcenter_user }}"
    password: "{{ vcenter_user_password }}"
    validate_certs: "{{ vcenter_validate_certs }}"
    name: "{{ config_vm_name }}"
    template: "{{ config_vm_template }}"
    datacenter: "{{ config_vcenter_datacenter }}"
    cluster: "{{ config_vcenter_cluster }}"
    folder: "{{ config_vm_folder }}"
    datastore: "{{ config_vcenter_datastore }}"
    resource_pool: "{{ resource_pool_name | default(omit) }}"
    state: present
    networks: "{{ networks_config | default(omit) }}"
    customization: "{{ customization_config | default(omit) }}"
    hardware: "{{ hardware_config | default(omit) }}"
  async: "{{ (not ansible_check_mode) | ternary(7200, omit) }}"
  poll: "{{ (not ansible_check_mode) | ternary(0, omit) }}"
  register: vm_creation
  when: not ansible_check_mode
  delegate_to: localhost
  connection: local

- name: "Wait for VM creation to complete (if async job was started)"
  ansible.builtin.async_status:
    jid: "{{ vm_creation.ansible_job_id }}"
  register: job_result
  until: job_result.finished
  retries: "{{ config_vm_async_retries }}"
  delay: "{{ config_vm_async_delay }}"
  when:
    - not ansible_check_mode
    - vm_creation.ansible_job_id is defined
  delegate_to: localhost
  connection: local

- name: "Power on VM (Check Mode)"
  ansible.builtin.debug:
    msg: "CHECK MODE: Would power on {{ config_vm_name }}"
  when: ansible_check_mode

- name: "Power on VM (idempotent - only powers on if not already on)"
  community.vmware.vmware_guest_powerstate:
    hostname: "{{ vcenter_host }}"
    username: "{{ vcenter_user }}"
    password: "{{ vcenter_user_password }}"
    validate_certs: "{{ vcenter_validate_certs }}"
    name: "{{ config_vm_name }}"
    datacenter: "{{ config_vcenter_datacenter }}"
    state: powered-on
  when: not ansible_check_mode
  delegate_to: localhost
  connection: local
