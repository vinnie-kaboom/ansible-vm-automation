---
# ===================================================================================
# PLAYBOOK: Main Site Playbook - VM Provisioning Automation
# ===================================================================================
# PURPOSE:
#   Orchestrates the complete end-to-end virtual machine vm-operations workflow.
#   This includes connectivity validation, VM creation, configuration validation,
#   and post-vm-operations checks. Designed for CI/CD or controlled infrastructure
#   automation environments.
# ===================================================================================
#
# WORKFLOW OVERVIEW:
#   1. Test vCenter connectivity and permissions
#   2. Provision Linux virtual machines in vCenter
#   3. Provision Windows virtual machines (optional)
#   4. Validate VM configuration and connectivity
#   5. Perform post-vm-operations checks and cleanup
#
# USAGE EXAMPLES:
#   ansible-playbook playbooks/site.yml -i inventory/hosts-back.bak --tags vm-operations
#   ansible-playbook playbooks/site.yml -i inventory/hosts-back.bak --limit cce3_gpc_linux --tags vm-operations
#   ansible-playbook playbooks/site.yml -i inventory/hosts-back.bak --tags validation
#
# INVENTORY GROUPS:
#   - runner: GitHub Actions runner / control node (local execution)
#   - cce3_gpc_linux: Linux virtual machines to vm-operations
#   - cce3_gpc_windows: Windows virtual machines to vm-operations
# ===================================================================================

# ================================================================================
# VM PROVISIONING ORCHESTRATION
# ================================================================================
# Each imported playbook represents a distinct workflow stage.
# Tags are used to control which steps run during execution.
# ================================================================================

# -------------------------------------------------------------------------------
# STEP 1: Post-Provisioning Status and Validation
# -------------------------------------------------------------------------------
# Performs VM operational checks and configuration validation.
# Typically executed after vm-operations is complete.
- import_playbook: provisioning/vm-operations/test/log-vm-parameters.yml
  tags: [status, verification, post_provision]

# -------------------------------------------------------------------------------
# STEP 2: vCenter Connectivity Testing
# -------------------------------------------------------------------------------
# Validates vCenter access, credentials, and API connectivity.
# Ensures environment readiness before vm-operations begins.
- import_playbook: provisioning/vm-operations/test/connection-parameters.yml
  tags: [validation, vcenter, connectivity, connection ]

# -------------------------------------------------------------------------------
# STEP 3: Linux VM Provisioning
# -------------------------------------------------------------------------------
# Creates and configures Linux virtual machines using templates or specs.
- import_playbook: provisioning/vm-operations/linux/provision_linux_vm.yml
  tags: [vm-operations, linux, connection ]

# -------------------------------------------------------------------------------
# STEP 4: Windows VM Provisioning (Optional)
# -------------------------------------------------------------------------------
# Uncomment to enable Windows VM vm-operations in mixed environments.
# Disabled by default for Linux-only workflows.
# - import_playbook: vm-operations/vm-operations/windows/provision_windows_vm.yml
#   tags: [vm-operations, windows]

# -------------------------------------------------------------------------------
# STEP 5: Error Handling and Cleanup
# -------------------------------------------------------------------------------
# Performs cleanup operations if vm-operations fails or validation errors occur.
# Ensures environment consistency by removing partially created VMs.
- import_playbook: provisioning/error_handling/cleanup.yml
  tags: [cleanup, error_handling]

# ================================================================================
# STEP 6: PRE-FLIGHT CHECKS
# ================================================================================

# Import connection diagnostics (runs before domain join)
- import_playbook: provisioning/domain-operations/validation/preflight_connection.yml
  tags: [preflight, connection, validation, domain_join]

# ================================================================================
# STEP 7: DOMAIN JOIN ORCHESTRATION
# ================================================================================

# Import Linux domain join playbook
# The playbook will skip gracefully if no hosts match the domain_linux group
- import_playbook: provisioning/domain-operations/join_domain/linux/join_linux_vm.yml
  tags: [domain_join, linux]
