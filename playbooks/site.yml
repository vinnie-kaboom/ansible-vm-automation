---
# ===================================================================================
# PLAYBOOK: Main Site Playbook - VM Provisioning and Domain Join
# ===================================================================================
#
# WORKFLOW OVERVIEW:
#   1. Validate VM configuration (no VM needed)
#   2. Test vCenter connectivity and permissions (no VM needed)
#   3. Provision Linux VMs
#   4. Provision Windows VMs (optional)
#   5. Pre-flight connection check (VM must exist, before domain join)
#   6. Domain join (VM must exist and be reachable)
#   7. Domain join validation (verify membership, SSSD, keytab, DNS)
#   8. Error handling and cleanup
#
# TAG USAGE:
#   --tags validation          Steps 1-2 (pre-provisioning checks, no VM needed)
#   --tags vm-operations       Steps 3-4 (create VMs)
#   --tags preflight           Step 5    (SSH/Python/sudo checks on live VM)
#   --tags domain_join         Steps 5-7 (preflight + domain join + validation)
#   --tags domain_validation   Step 7    (validate domain join only)
#   --tags cleanup             Step 8    (remove failed VMs)
#
# USAGE EXAMPLES:
#   ansible-playbook playbooks/site.yml --tags validation
#   ansible-playbook playbooks/site.yml --tags vm-operations
#   ansible-playbook playbooks/site.yml --tags domain_join
# ===================================================================================

# -------------------------------------------------------------------------------
# STEP 1: VM Configuration Validation (no VM needed)
# -------------------------------------------------------------------------------
# Validates inventory variables, template names, and resource settings.
- import_playbook: provisioning/vm-operations/test/log-vm-parameters.yml
  tags: [validation, status]

# -------------------------------------------------------------------------------
# STEP 2: vCenter Connectivity Testing (no VM needed)
# -------------------------------------------------------------------------------
# Validates vCenter access, credentials, and API connectivity.
- import_playbook: provisioning/vm-operations/test/connection-parameters.yml
  tags: [validation, vcenter, connectivity]

# -------------------------------------------------------------------------------
# STEP 3: Linux VM Provisioning
# -------------------------------------------------------------------------------
- import_playbook: provisioning/vm-operations/linux/provision_linux_vm.yml
  tags: [vm-operations, linux]

# -------------------------------------------------------------------------------
# STEP 4: Windows VM Provisioning (Optional)
# -------------------------------------------------------------------------------
# Uncomment to enable Windows VM provisioning.
# - import_playbook: provisioning/vm-operations/windows/provision_windows_vm.yml
#   tags: [vm-operations, windows]

# -------------------------------------------------------------------------------
# STEP 5: Pre-flight Connection Check (VM must exist)
# -------------------------------------------------------------------------------
# Tests SSH, Python, and sudo on the provisioned VM before domain join.
- import_playbook: provisioning/domain-operations/validation/preflight_connection.yml
  tags: [preflight, domain_join]

# -------------------------------------------------------------------------------
# STEP 6: Domain Join
# -------------------------------------------------------------------------------
- import_playbook: provisioning/domain-operations/join_domain/linux/join_linux_vm.yml
  tags: [domain_join, linux]

# -------------------------------------------------------------------------------
# STEP 7: Domain Join Validation (VM must be domain-joined)
# -------------------------------------------------------------------------------
# Validates domain membership, SSSD, keytab, DNS, and authentication.
- import_playbook: provisioning/domain-operations/validation/domain_validation.yml
  tags: [domain_join, domain_validation]

# -------------------------------------------------------------------------------
# STEP 8: Error Handling and Cleanup
# -------------------------------------------------------------------------------
- import_playbook: provisioning/error_handling/cleanup.yml
  tags: [cleanup, error_handling]
